[Unit]
Description=mistermorph console (API + SPA, sandboxed)
After=network-online.target mister-morph.service
Wants=network-online.target
StartLimitIntervalSec=10
StartLimitBurst=10

[Service]
Type=simple

# Example deployment layout:
# - Binary:  /opt/morph/mistermorph
# - Config:  /opt/morph/config.yaml
# - SPA:     /opt/morph/web/console/dist
ExecStart=/opt/morph/mistermorph --config /opt/morph/config.yaml --log-level info console serve --console-listen 127.0.0.1:9080 --console-base-path /console --console-static-dir /opt/morph/web/console/dist

# Secrets/config via environment (recommended).
# Suggested split:
# - /opt/morph/morph.env: non-secret config (permissions: 0640)
# - /opt/morph/morph.secrets.env: secret values (permissions: 0600)
#
# Common env vars:
# - MISTER_MORPH_CONSOLE_PASSWORD or MISTER_MORPH_CONSOLE_PASSWORD_HASH
# - MISTER_MORPH_SERVER_AUTH_TOKEN (for /tasks proxying to daemon API)
EnvironmentFile=-/opt/morph/morph.env
EnvironmentFile=-/opt/morph/morph.secrets.env

Restart=on-failure
RestartSec=2s

User=morph
Group=morph

StateDirectory=morph
StateDirectoryMode=0700
CacheDirectory=morph
CacheDirectoryMode=0700

WorkingDirectory=/var/lib/morph
Environment=MISTER_MORPH_FILE_CACHE_DIR=/var/cache/morph

NoNewPrivileges=yes
UMask=0077

PrivateTmp=yes
PrivateDevices=yes
DevicePolicy=closed

ProtectSystem=strict
ProtectHome=true
ProtectControlGroups=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectClock=true
ProtectHostname=true
ProtectProc=invisible
ProcSubset=pid

RestrictSUIDSGID=true
RestrictRealtime=true
RestrictNamespaces=true
LockPersonality=true
SystemCallArchitectures=native

InaccessiblePaths=/etc/systemd
InaccessiblePaths=/opt/morph/morph.env
InaccessiblePaths=/opt/morph/morph.secrets.env

# Console needs local daemon HTTP and browser clients.
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6

[Install]
WantedBy=multi-user.target
